<!doctype html>
<html>
	<head>
		<title>sRAT Dashboard</title>
		{{> css }}
	</head>
	<body>
		<h1>Dashboard</h1>
		<ul>
			<li><a href="/new">Create New Quiz</a></li>
			<li><a href="/dashboard/teams/new">Add New Team</a></li>
		</ul>		
		<div class="dashboard__component">
			<ul class="dashboard-quiz__list">
			</ul>
		</div>
		<script>
			const activateQuiz = function (qid){
				var xhr = new XMLHttpRequest();
				xhr.open('PUT', `{{dashboard_root}}/quizzes/${qid}/open`, true);
				xhr.setRequestHeader('Content-Type', 'application/json');
				xhr.send(JSON.stringify({'qid': qid}));
				xhr.onload = function () {
					var response = JSON.parse(this.responseText);
					if (response.error) {
						console.error(`something broked: ${response.error}`);
					} else {
						let link = $(`.open_quiz[data-qid='${qid}']`);
						link.off('click').on('click', function (e) {
							let qid = $(this).attr('data-qid');
							deactivateQuiz(qid);
						});
						link.html('Close');
					}
				};
			};
			
			const deactivateQuiz = function (qid){
				console.log('quiz deactivation is not yet implemented');
				let link = $(`.open_quiz[data-qid='${qid}']`);
				link.off('click').on('click', function (e) {
					let qid = $(this).attr('data-qid');
					activateQuiz(qid);
				});
				link.html('Open');
			};

			const buildQuizList = function (array){
				array.forEach((quiz) => {
					//console.log(quiz);
					let id = quiz.quizid;
					let name = quiz.name;
					let quiz_row = `<li class="quiz">
					<h3 class="quiz__title">${name}</h3>
					<ul class="quiz__control-container">
						<li class="quiz__control"><a href="${id}">Results</a></li>
						<li class="quiz__control"><a class="open_quiz" data-qid="${id}" href="#">Open</a></li>
						<li class="quiz__control"><a href="{{dashboard_root}}/quizzes/${id}/view">View</a></li>
						<li class="quiz__control"><a href="${id}">Delete</a></li>
					</ul>
				</li>`;
				let quizList = jQuery('.dashboard-quiz__list');
				quizList.append(quiz_row);
			});
			};
			const getRequest = function () {
				var xhr = new XMLHttpRequest();
				xhr.open('GET', '{{dashboard_root}}/quizzes/list', true);
				xhr.setRequestHeader('Content-Type', 'application/json');
				xhr.send();
				xhr.onload = function () {
					var response = JSON.parse(this.responseText);
					if (response.error) {
						console.error(`something broked: ${response.error}`);
					} else {
						buildQuizList(response);
						$('.open_quiz').click(function(e) {
							let qid = $(this).attr('data-qid');
							activateQuiz(qid);
						});
					}
				};
			};

			jQuery(document).ready(function($) {
				getRequest();
			});

		</script>
	</body>
</html>
