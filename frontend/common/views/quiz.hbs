<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	{{>css}}
</head>
<body>
	<h1 class="quiz__title"></h1>
	<div class="question__container">
		<div class="question">
			<p class="question__statement"></p>
			<div class="question__answers">
				<p class="question__answer"></p>
			</div>
		</div>
	</div>
	<script>
	const checkAnswer = function(qid, aid, button){
		let postData = {proposed: aid};
		var xhr = new XMLHttpRequest();
		xhr.open('POST', '{{dashboard_root}}/quizzes/{{quizid}}/' + qid + '/check', true);
		xhr.setRequestHeader('Content-Type', 'application/json');
		xhr.send(JSON.stringify(postData));
		xhr.onload = function () {
			var response = JSON.parse(this.responseText);
			if (response.error) {
				console.error(`something broked: ${response.error}`);
			} else {
				if (response.iscorrect){
					button.css('background-color','green');
				} else {
					button.css('background-color','red');
				}
			}
		};
	};
	const buildAnswers = function (id, answers){
		answers[0].forEach((answer) => {
			let qid = id;
			let statement = answer.statement;
			let aid = answer.answerid;
			let answerTemplate = `<button class="question__answer" data-qid="${qid}" data-aid="${aid}">${statement}</button>`;
			jQuery(`.question_${qid} > .question__answers`).append(answerTemplate);
		});
		jQuery('.question__answer').click(function(e){
			let qid = $(this).attr('data-qid');
			let aid = $(this).attr('data-aid');
			checkAnswer(qid, aid, $(this));
		});		
	};
	const buildQuiz = function (data){
		let title = data.name;
		jQuery('.quiz__title').text(title);

		// Print the questions and answers
		let questions = data.questions;
		questions.forEach((question) => {
			let statement = question.statement;
			let qid = question.questionid;
			let questionTemplate = `<div class="question question_${qid}" data-qid="${qid}">
			<p class="question__statement">${statement}</p>
			<div class="question__answers"></div>
		</div>`;
		$('.question__container').append(questionTemplate);
		buildAnswers(qid, question.answers);
		});
	};
	const getRequest = function () {
		var xhr = new XMLHttpRequest();
		xhr.open('GET', '{{dashboard_root}}/quizzes/{{quizid}}', true);
		xhr.setRequestHeader('Content-Type', 'application/json');
		xhr.send();
		xhr.onload = function () {
			var response = JSON.parse(this.responseText);
			if (response.error) {
				console.error(`something broked: ${response.error}`);
			} else {
				buildQuiz(response);
				return true;
			}
		};
	};
	jQuery(document).ready(function($) {
		getRequest();
	});
	</script>
</body>
</html>